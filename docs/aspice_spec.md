# RL78F23 I2C 단일 태스크 애플리케이션 - ASPICE SWE1/2/3 명세서

## 1. 목적과 범위
본 문서는 RL78F23 단일 태스크 I2C 슬레이브 애플리케이션에 대해 ASPICE SWE.1(소프트웨어 요구사항), SWE.2(소프트웨어 아키텍처 설계), SWE.3(소프트웨어 상세 설계) 활동을 지원하기 위해 필요한 소프트웨어 명세를 정리한다. 범위에는 자동 생성된 Renesas 드라이버 계층 위에서 동작하는 HAL, 스케줄러, 애플리케이션 글루 코드가 포함된다.

## 2. 참고 문헌
- Renesas RL78F23 하드웨어 사용자 매뉴얼
- Renesas Code Generator `r_config_iica0.h`, `r_cg_macrodriver.h`
- MISRA C:2023 가이드라인
- ASPICE PAM 4.0 (SWE.1/SWE.2/SWE.3 기본 실천 항목)

## 3. SWE.1 - 소프트웨어 요구사항 명세

### 3.1 가정
- 자동 생성된 드라이버 계층이 인터럽트 콜백과 하드웨어 제어 프리미티브(`R_Config_IICA0_*`)를 제공한다.
- 시스템 틱 타이머가 TM00 ISR을 통해 1 ms 인터럽트를 생성한다.
- I2C 마스터는 트랜잭션당 최대 32바이트의 메시지를 전송할 수 있다.
- 애플리케이션은 RTOS 없이 단일 협력형 메인 루프로 실행된다.

### 3.2 제약 사항
- MISRA C:2023과 RL78F23용 Renesas 컴파일러를 준수해야 한다.
- 스케줄러 태스크는 1 ms 시간 슬라이스 내에 실행을 완료해야 한다.
- 전원 온 자가 진단과 워치독 서비스는 본 범위 밖에서 처리된다.

### 3.3 요구사항 목록
| ID | 요구사항 | 근거 | 검증 방법 |
|----|-----------|------|-----------|
| REQ-I2C-001 | 시스템은 인터럽트 컨텍스트에서 수신된 I2C 슬레이브 메시지를 완전한 프레임 단위로 버퍼링해야 한다. | 마스터 데이터 프레임을 손실 없이 수집하기 위함. | 생성된 드라이버 스텁을 이용한 기능 시험; 링 버퍼 내용을 확인한다. |
| REQ-I2C-002 | 시스템은 IICA 드라이버가 전달하는 하드웨어 오류 이벤트를 표시하고 복구해야 한다. | 장애 발생 후 버스 가용성을 유지하기 위함. | 오류 주입 시험; 콜백 보고와 버스 리셋을 확인한다. |
| REQ-I2C-003 | 시스템은 5 ms를 초과하는 불완전 프레임을 감지하고 폐기해야 한다. | 오래된 또는 정체된 트랜잭션을 방지하기 위함. | 타이머 기반 오류 주입; 타임아웃 처리를 확인한다. |
| REQ-I2C-004 | 메인 루프는 시간 분할 스케줄링을 사용해 버퍼된 메시지를 처리하면서 다른 태스크가 블로킹되지 않도록 해야 한다. | 결정론적인 단일 태스크 실행을 유지하기 위함. | 스케줄러 단위 시험; 루프 지연을 측정한다. |
| REQ-I2C-005 | 시스템은 컨텍스트 정보를 포함한 오류 콜백 인터페이스를 상위 계층에 제공해야 한다. | 진단 및 로깅을 지원하기 위함. | `hal_i2c_report_error` 단위 시험. |
| REQ-I2C-006 | 솔루션은 자동 생성된 드라이버 구현과 독립적인 HAL API를 제공해야 한다. | 이식성과 테스트 용이성을 확보하기 위함. | 코드 점검; 인터페이스 모의 시험. |

## 4. SWE.2 - 소프트웨어 아키텍처 설계

### 4.1 모듈 분해
- **HAL_I2C** (`include/hal_i2c.h`, `src/hal_i2c.c`): 인터럽트 수준 버퍼링, 타임아웃 감지, 하드웨어 재가동 로직을 캡슐화하며 `HAL_I2C_PopMessage`와 오류 콜백으로 상위 계층과 연동한다.
- **HAL_SCHED** (`include/hal_scheduler.h`, `src/hal_scheduler.c`): 틱 기반 활성화와 래핑 안전 데드라인 처리를 제공하는 협력형 스케줄러를 구현한다.
- **APP_MAIN** (`src/app_main.c`): 스케줄러 태스크를 구성하고 HAL 콜백을 등록하며, 메시지 처리와 워치독 서비스를 담당한다.
- **ISR 계층** (`src/timer_isr.c`, `src/r_config_iica0_user.c`): 드라이버에서 생성된 인터럽트를 HAL/스케줄러 진입점으로 전달한다.

### 4.2 인터페이스
| 제공 인터페이스 | 설명 | 사용 주체 |
|------------------|------|-----------|
| `HAL_I2C_Init`, `HAL_I2C_ResetSlave`, `HAL_I2C_PopMessage` | HAL 초기화 및 데이터 접근 | 애플리케이션 계층 |
| `HAL_I2C_On*` 콜백 | 버스 이벤트를 처리하기 위해 드라이버 ISR이 호출 | 드라이버 글루(`r_config_iica0_user.c`) |
| `HAL_SCHED_Init`, `HAL_SCHED_RegisterTasks`, `HAL_SCHED_RunOnce`, `HAL_SCHED_TickISR` | 스케줄러 서비스 | `app_main.c`, `timer_isr.c` |
| 오류 콜백 `hal_i2c_error_callback_t` | HAL 오류를 애플리케이션에 보고 | `app_main.c` |

### 4.3 데이터 흐름 요약
1. I2C ISR(`R_Config_IICA0_*`)이 이벤트를 HAL에 전달한다.
2. HAL은 메시지 프레임을 버퍼링하고 오류 상태를 기록한다.
3. 타이머 ISR이 스케줄러 틱과 HAL 타임아웃 카운터를 갱신한다.
4. 메인 루프가 스케줄러를 호출해 등록된 태스크를 실행하고, 메시지 처리 태스크가 버퍼를 비우며 `process_message`를 수행한다.

### 4.4 안전 및 결함 처리
- 하드웨어 오류는 애플리케이션에 알린 뒤 `HAL_I2C_ResetSlave`를 호출한다(`src/hal_i2c.c:211`).
- 버퍼 오버런과 타임아웃은 컨텍스트가 포함된 오류 콜백을 생성한다(`src/hal_i2c.c:187`, `src/hal_i2c.c:259`).
- 스케줄러는 잘못된 태스크 등록을 방지하고 카운터 래핑을 처리한다(`src/hal_scheduler.c:39`, `src/hal_scheduler.c:93`).

## 5. SWE.3 - 소프트웨어 상세 설계 및 구현

### 5.1 함수 수준 설계(주요 발췌)
| 함수 | 목적 | 입력 | 출력 | 참조 |
|------|------|------|------|------|
| `HAL_I2C_Init` | 컨텍스트 초기화, 오류 콜백 등록, 하드웨어 준비 | 오류 콜백 포인터 | 없음 | `src/hal_i2c.c:153` |
| `HAL_I2C_OnByteReceived` | 현재 프레임에 바이트를 추가하고 최대 길이를 강제 | 데이터 바이트 | 없음 | `src/hal_i2c.c:179` |
| `HAL_I2C_Tick1ms` | 바이트 간 타임아웃을 추적하고 오래된 프레임을 보고 | 틱 호출 | 없음 | `src/hal_i2c.c:245` |
| `HAL_SCHED_RunOnce` | 블로킹 없이 준비된 태스크 실행 | 없음 | 없음 | `src/hal_scheduler.c:67` |
| `App_I2C_ErrorHandler` | HAL 오류에 대한 애플리케이션 측 대응 | 오류 컨텍스트 포인터 | 없음 | `src/app_main.c:47` |

### 5.2 자료구조
- `hal_i2c_context_t` (링 버퍼, 진행 중 메시지, 오류 콜백 보관).
- `hal_sched_task_t` (함수 포인터, 데드라인, 주기).

### 5.3 타이밍 동작
- 스케줄러 틱: 1 ms (`HAL_SCHED_Init(UINT16_C(1000))`, `timer_isr.c`).
- 메시지 처리 태스크 주기: 1 ms (`src/app_main.c:17`).
- 하우스키핑 태스크 주기: 10 ms (`src/app_main.c:18`).
- I2C 프레임 타임아웃: 5 ms (`HAL_I2C_SLAVE_TIMEOUT_MS`).

### 5.4 오류 처리 로직
| 조건 | 감지 방법 | 복구 조치 | 추적 |
|------|-----------|-----------|------|
| 하드웨어 버스 오류 | `HAL_I2C_OnHardwareError` | 오류 보고, 슬레이브 리셋 | `src/hal_i2c.c:211` |
| 버퍼 오버런 | `HAL_I2C_OnByteReceived`와 링 용량 확인 | 드롭 보고, 슬레이브 리셋 | `src/hal_i2c.c:187` |
| 타임아웃 | `HAL_I2C_Tick1ms` | 드롭 보고, 슬레이브 리셋 | `src/hal_i2c.c:259` |
| 고립된 STOP | 수신 중이 아닐 때 `HAL_I2C_OnStopCondition` | 프레임 오류 보고 | `src/hal_i2c.c:225` |

### 5.5 추적 매트릭스
| 요구사항 | 아키텍처 요소 | 상세 설계 / 코드 |
|-----------|---------------|-------------------|
| REQ-I2C-001 | 메시지 버퍼링(HAL_I2C) | `src/hal_i2c.c:155-206`, `src/app_main.c:27-38` |
| REQ-I2C-002 | 오류 처리 블록 | `src/hal_i2c.c:187-243`, `src/app_main.c:47-75` |
| REQ-I2C-003 | 타임아웃 모니터 | `src/hal_i2c.c:245-269` |
| REQ-I2C-004 | 협력형 스케줄러 | `src/hal_scheduler.c:67-109`, `src/app_main.c:86-105` |
| REQ-I2C-005 | 오류 콜백 인터페이스 | `include/hal_i2c.h:39`, `src/hal_i2c.c:119-146` |
| REQ-I2C-006 | HAL API 추상화 | `include/hal_i2c.h:41-51`, `src/r_config_iica0_user.c` |

### 5.6 단위 시험 고려사항
- 모의 드라이버 콜백으로 I2C 트래픽과 오류 플래그를 시뮬레이션한다.
- 링 버퍼 래핑과 메시지 길이 제한을 검증한다.
- 타이머 틱을 주입해 타임아웃 동작을 확인한다.
- 스케줄러에 0 주기와 큰 주기의 태스크를 혼합해 래핑 내성을 검증한다.

## 6. 준수 사항
- 코드는 MISRA C:2023 지침에 맞춰 작성되며 별도의 체크리스트로 관리된다.
- 본 문서는 요구사항, 아키텍처, 구현 산출물 간 연결을 제공해 ASPICE SWE.1~SWE.3 추적성을 지원한다.
- 추가 ASPICE 평가를 위해서는 검토, 시험, 형상 관리 기록이 필요하며 이는 본 문서 범위 밖이다.

## 7. 개정 이력
| 버전 | 날짜 | 작성자 | 설명 |
|-------|------|--------|------|
| 0.1 | 2025-09-28 | Codex Agent | ASPICE SWE 명세 초안 작성. |

## 8. SWE.4 - 소프트웨어 통합 및 통합 시험 계획
- **시험 목적**: HAL, 스케줄러, 드라이버 콜백 계층 간 통합을 검증해 인터페이스 계약을 보장한다.
- **통합 환경**: 모의 드라이버 콜백(`R_Config_IICA0_*`)을 통해 HAL_I2C 함수를 호출하고 TM00 ISR을 시뮬레이션해 `HAL_SCHED_TickISR` 및 `HAL_I2C_Tick1ms`를 실행한다.
- **시험 전략**:
  - HIL 또는 에뮬레이터를 사용해 I2C 이벤트를 주입하고 링 버퍼 및 오류 콜백 동작을 관찰한다.
  - 최대 메시지 길이, 빠른 START/STOP 시퀀스, 타임아웃 상황 등 경계 조건을 주입한다.
  - 스케줄러가 구성된 순서대로 태스크를 실행하며 데드라인을 놓치지 않는지 확인한다.
- **합격/실패 기준**: 통합 환경에서 REQ-I2C-001~REQ-I2C-006 요구사항이 모두 충족되고 미해결 결함이 없어야 한다.

## 9. SWE.5 - 소프트웨어 자격 시험 및 함수 인터페이스 카탈로그

### 9.1 함수 인터페이스 요약
| 함수 | 계층 | 입력 | 출력 | 사전 조건 | 사후 조건 | 비고 |
|------|------|------|------|-----------|-----------|------|
| `HAL_I2C_Init(hal_i2c_error_callback_t error_cb)` | HAL | `error_cb`: 선택적 오류 처리기 포인터 | 없음 | 스케줄러 업타임 서비스 사용 가능, 드라이버 미시작 | HAL 컨텍스트 초기화 및 하드웨어 준비; 오류 콜백 저장 | 콜백 없음 시 널 포인터 허용. |
| `HAL_I2C_ResetSlave(void)` | HAL | 없음 | 없음 | I2C 드라이버 초기화 완료 | I2C 주변장치를 정지 후 재시작, 현재 메시지 초기화 | 오류 복구 시 사용. |
| `HAL_I2C_PopMessage(hal_i2c_message_t *message)` | HAL | `message`: 널이 아닌 버퍼 포인터 | `bool`: 메시지 획득 여부 | 링 버퍼에 메시지가 존재할 수 있음 | 성공 시 최신 메시지를 복사하고 head/tail을 갱신 | 버퍼가 비었거나 포인터가 널이면 FALSE 반환. |
| `HAL_I2C_OnStartCondition(uint8_t hw_status_flags)` | HAL (ISR) | 하드웨어 상태 비트 | 없음 | I2C START 인터럽트 트리거 | 새 프레임 수집 시작, 타임아웃 카운터 리셋 | 진단을 위해 플래그 저장. |
| `HAL_I2C_OnByteReceived(uint8_t data)` | HAL (ISR) | 수신 바이트 | 없음 | `receiving` 상태가 true | 바이트 추가 또는 오버런 처리 | 오버런 시 오류 보고 및 슬레이브 리셋. |
| `HAL_I2C_OnStopCondition(uint8_t hw_status_flags)` | HAL (ISR) | 하드웨어 상태 비트 | 없음 | 프레임 진행 중 | 용량이 있으면 메시지를 큐에 저장 | 수신 중이 아니면 프레임 오류 보고. |
| `HAL_I2C_OnHardwareError(uint8_t hw_status_flags)` | HAL (ISR) | 오류 플래그 | 없음 | 하드웨어 예외 발생 | 오류 콜백 호출 후 하드웨어 리셋 | 항상 슬레이브를 재초기화. |
| `HAL_I2C_Tick1ms(void)` | HAL | 없음 | 없음 | 1 ms마다 호출 | 타임아웃 카운터 증가, 필요 시 타임아웃 보고 | 스케줄러 틱 일관성 필요. |
| `HAL_SCHED_Init(uint16_t tick_hz)` | 스케줄러 | 틱 주파수(Hz) | 없음 | 없음 | 스케줄러 컨텍스트 초기화, 클럭 비율 저장 | 업타임 변환을 위해 `tick_hz` > 0 가정. |
| `HAL_SCHED_RegisterTasks(hal_sched_task_t *tasks, uint8_t task_count)` | 스케줄러 | 태스크 배열 포인터, 태스크 수 | 없음 | `tasks` 배열이 `task_count` 크기로 준비됨 | 현재 틱 기준으로 데드라인 초기화 | 널/0 입력 시 스케줄러 초기화. |
| `HAL_SCHED_TickISR(void)` | 스케줄러 (ISR) | 없음 | 없음 | 타이머 ISR 활성화 | 업타임 틱 증가 | 설정한 주기로 반드시 호출. |
| `HAL_SCHED_RunOnce(void)` | 스케줄러 | 없음 | 없음 | 태스크가 등록됨 | 준비된 태스크를 순서대로 실행 | 준비되지 않은 태스크는 건너뜀. |
| `App_I2C_ErrorHandler(const hal_i2c_error_context_t *context)` | 애플리케이션 | 오류 컨텍스트 포인터 | 없음 | HAL 오류 콜백이 호출됨 | 버스 리셋, 로깅 등 복구 동작 수행 | MISRA에 따라 널 컨텍스트는 무시. |
| `process_message(const hal_i2c_message_t *message)` | 애플리케이션 | 메시지 포인터 | 없음 | 스케줄러 태스크에서 호출 | 애플리케이션 고유 처리를 실행 | 프로젝트별 로직 추가 예정. |
| `TM00_ISR(void)` | ISR | 없음 | 없음 | 타이머 인터럽트 구성 완료 | 스케줄러 틱과 HAL 타임아웃 호출 | 벡터 연결을 위한 pragma 필요. |
| `R_Config_IICA0_*Callback(...)` | ISR 글루 | 드라이버에서 전달된 상태/데이터 | 없음 | 드라이버가 콜백을 사용하도록 설정됨 | 이벤트를 HAL에 전달 | `src/r_config_iica0_user.c`에서 유지. |

### 9.2 시험 케이스 매핑 가이드라인
- **기능적 커버리지**: 요구사항별 TC ID를 도출한다(예: TC-I2C-001은 START/바이트/STOP 시퀀스를 실행하고 `HAL_I2C_PopMessage`를 확인해 REQ-I2C-001을 검증).
- **인터페이스 강건성**: 널 포인터, 0개 태스크, 다양한 하드웨어 플래그 조합에 대한 음성 테스트를 포함한다.
- **타이밍 검증**: 타이머 스텁을 사용해 `HAL_I2C_Tick1ms` 증가량을 조작하고 기대 범위 내에서 타임아웃을 확인한다.
- **오류 복구**: 각 하드웨어 오류 플래그에 대해 `App_I2C_ErrorHandler`가 올바른 코드를 수신하고 버스 리셋을 수행하는지 검증한다.

### 9.3 검증 산출물
- 위 표에 명시된 함수와 연결된 TC 명세.
- 각 요구사항에 대해 실제 동작과 기대 동작을 비교한 시험 로그.
- SWE.4/SWE.5 기대치에 부합하도록 인터페이스 정의와 시험 설계를 검토한 기록.
